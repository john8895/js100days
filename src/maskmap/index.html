<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>Mask Map practice-3</title>
    <!--    leaflet-->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
    <!--    markerCluster-->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.4.1/MarkerCluster.css"></link>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.4.1/MarkerCluster.Default.css"></link>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.4.1/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<aside class="sidebar">
    <header class="sidebar__header">
        <h1>口罩即時地圖</h1>
        <div class="float-right sidebar__source">
            <em>來源：衛福部</em>
            <span class="sidebar__today" id="todayDate"></span>
        </div>
        <br class="clearfix">
        <div class="banner" id="whoCanBuy">
        </div>
        <!--        <div class="sidebar__nowLocation">-->
        <!--            <h3>現在位置</h3>-->
        <!--            <input type="text" value="" placeholder="現在位置" onClick="codeAddress()" id="address" >-->
        <!--            <input type="button" value="搜尋">-->
        <!--        </div>-->
        <div class="sidebar__nowLocation">
            <h3>選擇你的位置</h3>

            <div class="from-group">
                <div role="tw-city-selector" id="citySelector"></div>
            </div>

        </div>
        <hr>
        <div class="sidebar__maskFilter" id="fliterMask">
            <input type="button" value="所有口罩" id="btn__allMask">
            <input type="button" value="成人口罩" id="btn__adultMask">
            <input type="button" value="兒童口罩" id="btn__childMask">
        </div>
    </header>
    <main>
        <h2 class="maskMap-title" id="maskMapTitle">尚有庫存店家 共 <span id="maskLeftTitle">0</span> 筆</h2>
        <div class="sidebar__store" id="storeList">
        </div>
    </main>
</aside>
<div id="map"></div>

<!--行政區插件-->
<script src="https://cdn.jsdelivr.net/npm/tw-city-selector@2.1.0/dist/tw-city-selector.min.js"></script>
<script>
    //註冊地圖
    var map = L.map('map', {
        center: [24.126471, 120.658887],
        zoom: 16
    });

    //引入圖專
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    //圖示
    var greyIcon = new L.Icon({
        iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-grey.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });
    var blueIcon = new L.Icon({
        iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });
    var redIcon = new L.Icon({
        iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    //建立marker
    // L.marker([24.126471, 120.658887], {icon: redIcon}).addTo(map)
    //     .bindPopup('<h1>你的位置</h1>')
    //     .openPopup();

    //新增圖層，marker群組
    var markers = new L.MarkerClusterGroup().addTo(map);

    //讀取遠端資料
    var data;
    var xhr = new XMLHttpRequest();
    xhr.open('get', 'https://raw.githubusercontent.com/kiang/pharmacies/master/json/points.json');
    xhr.send();

    xhr.onload = function () {
        data = JSON.parse(xhr.responseText).features;
        updateMap();
    }

    // map.removeLayer(markers) //移除圖層

    function updateMap() {
        //迴圈取得資料，並更新在右側地圖上
        for (var i = 0; i < data.length; i++) {
            //判斷有無口罩，無就給灰色圖示
            var iconColor = data[i].properties.mask_adult === 0 ? greyIcon : blueIcon;

            markers.addLayer(
                L.marker([data[i].geometry.coordinates[1], data[i].geometry.coordinates[0]],
                    {icon: iconColor})
                    .bindPopup(`
                        <div>${data[i].properties.name}</div>
                        <hr>
                        <ul>
                            <li>成人：${data[i].properties.mask_adult}</li>
                            <li>兒童：${data[i].properties.mask_child}</li>
                            <li>地址：${data[i].properties.address}</li>
                        </ul>
                `))
        }
        map.addLayer(markers)
    }

    // 選擇行政區插件
    new TwCitySelector();
    onload = function () {
        var select = document.getElementById('citySelector');
        var city = select.children[0];
        var district = select.children[1];
        district.onchange = function () {
            var keywords = city.value + district.value
            updateMaskList(keywords);
            // updateMap();
        }
    }
    var addrDataArr = [];

    function updateMaskList(keywords) {
        var storeList = document.getElementById('storeList');
        var maskLeftTitle = document.getElementById('maskLeftTitle');
        var maskLeftNum = 0;
        var str = '';
        addrDataArr = [];
        //篩選數據
        var result=data.filter(function (value) {
            return value.properties.address.indexOf(keywords)!==-1?keywords:false;
        })
        console.log(result.filter(value=>value.properties.address.indexOf('好好')));

        for (var i = 0; i < result.length; i++) {
            //根據選擇城市、區域，進行數據篩選
                str += `<article>
                            <h4>${result[i].properties.name}</h4>
                                <ul>
                                    <li>${result[i].properties.address}</li>
                                    <li>${result[i].properties.phone}</li>
                    <!--                <li>今日營業時間：${result[i].properties.available}</li>-->
                                </ul>
                            <div class="sidebar__maskNum">
                                <div class="mask-type mask-adult ${result[i].properties.mask_adult === 0 ? 'noMask' : ' '} "><em>成人</em> ${result[i].properties.mask_adult}</div>
                                <div class="mask-type mask-child ${result[i].properties.mask_child === 0 ? 'noMask' : ' '}"><em>兒童</em> ${result[i].properties.mask_child}</div>
                            </div>
                            <span class="sidebar__updateTime">
                                ${result[i].properties.updated} 更新
                            </span>
                                  </article>`;
                maskLeftNum++;
                addrDataArr.push(result[i]);
        }
        storeList.innerHTML = str; //更新左側藥局清單
        maskLeftTitle.innerText = maskLeftNum; //更新 尚有庫存店家筆數

        // map.addLayer(markers)
    }
    function updateMarker(lat,lon) {
        L.marker([lat, lon], {icon: redIcon}).addTo(map)
            .bindPopup('<h1>你的位置</h1>')
            .openPopup();
    }

    var adultBtn = document.getElementById('btn__adultMask');
    var childBtn = document.getElementById('btn__childMask');
    var alldBtn = document.getElementById('btn__allMask');

    adultBtn.onclick = filterMaskAdult;
    childBtn.onclick = filterMaskChild;
    alldBtn.onclick = filterMaskAll;

    //篩選成人、兒童口罩
    function filterMaskAdult() {
        var storeList = document.getElementById('storeList');
        var maskLeftTitle = document.getElementById('maskLeftTitle');
        var maskLeftNum = 0;
        var str = '';

        for (var i = 0; i < addrDataArr.length; i++) {
            if (addrDataArr[i].properties.mask_adult !== 0) {
                str += `<article>
                            <h4>${addrDataArr[i].properties.name}</h4>
                                <ul>
                                    <li>${addrDataArr[i].properties.address}</li>
                                    <li>${addrDataArr[i].properties.phone}</li>
                    <!--                <li>今日營業時間：${addrDataArr[i].properties.available}</li>-->
                                </ul>
                            <div class="sidebar__maskNum">
                                <div class="mask-type mask-adult ${addrDataArr[i].properties.mask_adult === 0 ? 'noMask' : ' '} "><em>成人</em> ${addrDataArr[i].properties.mask_adult}</div>
                                <div class="mask-type mask-child ${addrDataArr[i].properties.mask_child === 0 ? 'noMask' : ' '}"><em>兒童</em> ${addrDataArr[i].properties.mask_child}</div>
                            </div>
                            <span class="sidebar__updateTime">
                                ${addrDataArr[i].properties.updated} 更新
                            </span>
                                  </article>`;
                maskLeftNum++;
            }
        }
        storeList.innerHTML = str; //更新左側藥局清單
        maskLeftTitle.innerText = maskLeftNum; //更新 尚有庫存店家筆數
    }

    function filterMaskChild() {
        var storeList = document.getElementById('storeList');
        var maskLeftTitle = document.getElementById('maskLeftTitle');
        var maskLeftNum = 0;
        var str = '';

        for (var i = 0; i < addrDataArr.length; i++) {
            if (addrDataArr[i].properties.mask_child !== 0) {
                str += `<article>
                            <h4>${addrDataArr[i].properties.name}</h4>
                                <ul>
                                    <li>${addrDataArr[i].properties.address}</li>
                                    <li>${addrDataArr[i].properties.phone}</li>
                    <!--                <li>今日營業時間：${addrDataArr[i].properties.available}</li>-->
                                </ul>
                            <div class="sidebar__maskNum">
                                <div class="mask-type mask-adult ${addrDataArr[i].properties.mask_adult === 0 ? 'noMask' : ' '} "><em>成人</em> ${addrDataArr[i].properties.mask_adult}</div>
                                <div class="mask-type mask-child ${addrDataArr[i].properties.mask_child === 0 ? 'noMask' : ' '}"><em>兒童</em> ${addrDataArr[i].properties.mask_child}</div>
                            </div>
                            <span class="sidebar__updateTime">
                                ${addrDataArr[i].properties.updated} 更新
                            </span>
                                  </article>`;
                maskLeftNum++;
            }
        }
        storeList.innerHTML = str; //更新左側藥局清單
        maskLeftTitle.innerText = maskLeftNum; //更新 尚有庫存店家筆數
    }

    function filterMaskAll() {
        var storeList = document.getElementById('storeList');
        var maskLeftTitle = document.getElementById('maskLeftTitle');
        var maskLeftNum = 0;
        var str = '';

        for (var i = 0; i < addrDataArr.length; i++) {
            str += `<article>
                            <h4>${addrDataArr[i].properties.name}</h4>
                                <ul>
                                    <li>${addrDataArr[i].properties.address}</li>
                                    <li>${addrDataArr[i].properties.phone}</li>
                    <!--                <li>今日營業時間：${addrDataArr[i].properties.available}</li>-->
                                </ul>
                            <div class="sidebar__maskNum">
                                <div class="mask-type mask-adult ${addrDataArr[i].properties.mask_adult === 0 ? 'noMask' : ' '} "><em>成人</em> ${addrDataArr[i].properties.mask_adult}</div>
                                <div class="mask-type mask-child ${addrDataArr[i].properties.mask_child === 0 ? 'noMask' : ' '}"><em>兒童</em> ${addrDataArr[i].properties.mask_child}</div>
                            </div>
                            <span class="sidebar__updateTime">
                                ${addrDataArr[i].properties.updated} 更新
                            </span>
                                  </article>`;
            maskLeftNum++;
        }
        storeList.innerHTML = str; //更新左側藥局清單
        maskLeftTitle.innerText = maskLeftNum; //更新 尚有庫存店家筆數
    }



    //接著要做：
    //選擇區域，更新左側列表後，右側地圖要跟著連動
    //點選藥局名稱，右側地圖跳到以該藥局為中心（center座標改變）
    /*
     * bug:
     * 1.地址中有「台」跟「臺」，要想該怎麼解決，還是用兩個字串判斷兩次？
     */


    var fakeData = [
        {
            "type": "Feature",
            "properties": {
                "id": "5901012409",
                "name": "家音藥局",
                "phone": "02 -37652080",
                "address": "台北市大安區民生東路5段73號",
                "mask_adult": 738,
                "mask_child": 100,
                "updated": "2020\/03\/29 09:23:44",
                "available": "星期一上午看診、星期二上午看診、星期三上午看診、星期四上午看診、星期五上午看診、星期六上午看診、星期日上午看診、星期一下午看診、星期二下午看診、星期三下午看診、星期四下午看診、星期五下午看診、星期六下午看診、星期日下午看診、星期一晚上看診、星期二晚上看診、星期三晚上看診、星期四晚上看診、星期五晚上看診、星期六晚上看診、星期日晚上看診",
                "note": "口罩販售時段 週一~五 16:00起、週六、日18:00起",
                "custom_note": "實名制口罩販售時段\n週一~週五 14:00~22:00\n週六、週日 18:00~22:00\n每日依據配量販售，售完為止",
                "website": "",
                "county": "臺北市",
                "town": "松山區",
                "cunli": "東榮里",
                "service_periods": "NNNNNNNNNNNNNNNNNNNNN"
            },
            "geometry": {
                "type": "Point",
                "coordinates": [
                    120.298599,
                    22.606925
                ]
            }
        },
        {
            "type": "Feature",
            "properties": {
                "id": "5901012490",
                "name": "中美藥局",
                "phone": "02 -27627468",
                "address": "台北市松山區富錦街531號",
                "mask_adult": 519,
                "mask_child": 59,
                "updated": "2020\/03\/29 09:23:44",
                "available": "星期一上午看診、星期二上午看診、星期三上午看診、星期四上午看診、星期五上午看診、星期六上午看診、星期日上午看診、星期一下午看診、星期二下午看診、星期三下午看診、星期四下午看診、星期五下午看診、星期六下午看診、星期日下午看診、星期一晚上看診、星期二晚上看診、星期三晚上看診、星期四晚上看診、星期五晚上看診、星期六晚上看診、星期日晚上看診",
                "note": "本局每日早上9:00，發放口罩號碼牌",
                "custom_note": "",
                "website": "",
                "county": "臺北市",
                "town": "松山區",
                "cunli": "新益里",
                "service_periods": "NNNNNNNNNNNNNNNNNNNNN"
            },
            "geometry": {
                "type": "Point",
                "coordinates": [
                    120.298867,
                    22.603082
                ]
            }
        }
    ];
    // var keyword = '台北市大安區';
    // for(var i=0;i<fakeData.length;i++){
    //     if(fakeData[i].properties.address.indexOf(keyword)!==-1){
    //         console.log(fakeData[i].properties.name)
    //     }
    // }

    // for (var i = 0; i < fakeData.length; i++) {
    //     console.log(fakeData.filter(keyword))

    // var result = fakeData[i].filter(fakeData[i].properties.address.indexOf(keyword) !== -1 ? keyword : false)
    // }
    // console.log(result);


</script>
</body>
</html>